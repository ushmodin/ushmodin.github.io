---
layout: post
title: Мысли о C10K
tags:
  - hightload
  - C10K
main-class: C10K
introduction: 'Немного мыслей о - проблеме C10K'
draft: true
---

**Друзья, всем привет!**

Если обратиться к (wiki)[https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%BE%D0%B1%D0%BB%D0%B5%D0%BC%D0%B0_10000_%D1%81%D0%BE%D0%B5%D0%B4%D0%B8%D0%BD%D0%B5%D0%BD%D0%B8%D0%B9] то проблема C10K - это задача конфигурирования сервера способного обслуживать 10000 подключений одновременно.
Странно почему это проблема ведь это круто, что на наш сервер пришло такое количество запросов.
И заметьте, пришли не в течении секунды или минуты а одновременно.
Хотя сложно представить, что значит "одновременно" для процессора, который работает по тактам.
Предположим под "одновременно" подразумевается промежуток времени стремящийся к нулю.

Далее в статье говорится что аппаратное обеспечение без проблем справляется с такой задачей, но проблема может возникнуть в алгоритме.




Предположим у нас есть стартап в виде мобильного приложения и серверной части на php или на java.
Если повезет, однажды у нас могут возникнуть ошибки типа мобильное приложение обратилось к серверу за данными а сервер сразу закрыл соединение или вернул HTTP код 429 (Too many requests). 
Это значит, что можно открывать бутылки с шампанским. 
Потому что у нас настолько много клиентов, что чтобы обработать все их запросы не хватило настроек по умолчанию.

Для Apache Tomcat 7 по умолчанию количество одновременно обрабатываемых запросов ограничено на 200. 
Если в момент когда обрабатываются 200 запросов придет еще один, то он будет поставлен в очередь. 
Очередь тоже ограничена на 100 запросов. Если не хватит 200 потоков и очереди из 100 элементов, то Tomcat будет сразу же закрывать соединения, не выполняя никаких действий.


Давайте представим, что нам пришла интересная идея для стартапа. 
Мы фигак-фигак, накидали мобильное приложение и сервер для него и в продакшен. 
Попросили друзей попробовать потыкать, написали статьи на хабр или [http://vc.ru]. 
Всем понравилось и количество скачеваний начинает расти. 
Мы потирая руки уже начали продумывать способ монетизации. 
Но на почту начали приходить письма об ошибках. 
Давайте пропустим ошибки логики или программирования. 
Сейчас хотелось бы поговорить об ошибках когда мобильное приложение обратилось на сервер за данными,
а сервер отказывался принимать подключение или вернул HTTP код 429 (Too many requests).

Сервер ведет себя таким образом, когда количество одновременно обрабатываемых запросов достигло определенного количества. 
И чтобы сохранить роботоспособность и довести до конца уже работающие запросы, сервер отказывается принимать следующие запросы. 

Сервер Apache Tomcat7 каждого запроса создает отдельный поток.
После того как ответ отправлен, поток переходит в режим ожидания.
Если во время того пока обрабатывался запрос, пришел другой запрос будет создан отдельный поток.
По умолчанию, максимальное количество одновременно работающих потоков 200. Если пришло больше, то потоки не создаются а запросы становятся в очередь. По умолчанию длинна очереди 100. Получается, если в короткий промежуток времени пришло 300 запросов, то последующие запросы сервер откажется принимать. Этот промежуток времени должен быть меньше чем время обработки запроса.
 
